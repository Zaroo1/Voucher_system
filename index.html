<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Buy WAEC Vouchers — TwinAzz</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; max-width:700px; margin:30px auto; padding:20px; }
    label { display:block; margin-top:10px }
    input, select { padding:8px; width:100%; box-sizing:border-box; }
    button { margin-top:12px; padding:10px 16px; }
    .result { margin-top:16px; white-space:pre-wrap; background:#f6f6f6; padding:12px; border-radius:6px; }
  </style>
</head>
<body>
  <h2>Buy WAEC Voucher</h2>
  <form id="buyForm" onsubmit="return false;">
    <label>Full name (optional)
      <input id="fullname" type="text" placeholder="Full name">
    </label>
    <label>Email (Gmail recommended)
      <input id="email" type="email" required placeholder="buyer@gmail.com">
    </label>
    <label>Quantity
      <select id="qty">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="8">8</option>
        <option value="10">10</option>
      </select>
    </label>

    <p id="priceDisplay">Price each: ₵24 — Total: ₵24</p>

    <button id="payBtn">Pay & Get Voucher</button>
  </form>

  <div style="margin-top:20px;">
    <h4>Or re-download by reference</h4>
    <input id="refInput" placeholder="Enter reference">
    <button id="fetchBtn">Fetch Voucher</button>
  </div>

  <div id="result" class="result" style="display:none"></div>

  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script>
    const PAYSTACK_PUBLIC_KEY = 'pk_test_5ac575deecd34c69d0e21584d36d46df951b0224';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbydFVop5oqafC_XmzecYa4p-zOufkt4rLG9pzSW03Er91DTT0eiYmiJE3sPG7SApjdl/exec';

    const qtyEl = document.getElementById('qty');
    const priceDisplay = document.getElementById('priceDisplay');
    const emailEl = document.getElementById('email');
    const payBtn = document.getElementById('payBtn');
    const resultEl = document.getElementById('result');
    const fullnameEl = document.getElementById('fullname');

    function computePriceEach(qty) {
      // reflect same logic as Apps Script
      const TEST_MODE = false; // set true here for local dev if desired
      if (TEST_MODE) return 1.00;
      if (qty >= 10) return 19.00;
      if (qty >= 5) return 22.00;
      return 24.00;
    }

    function updatePrice() {
      const q = Number(qtyEl.value);
      const per = computePriceEach(q);
      const total = (per * q).toFixed(2);
      priceDisplay.innerText = `Price each: ₵${per} — Total: ₵${total}`;
    }
    qtyEl.addEventListener('change', updatePrice);
    updatePrice();

    payBtn.addEventListener('click', function () {
      const email = emailEl.value.trim();
      if (!email) { alert('Enter email'); return; }
      const qty = Number(qtyEl.value);
      const per = computePriceEach(qty);
      const total = (per * qty);
      // Paystack amount is in kobo (GHS * 100)
      const amountKobo = Math.round(total * 100);

      // generate a unique reference client-side (Paystack also generates one)
      const ref = 'txn-' + Date.now() + '-' + Math.floor(Math.random()*1000);

      const handler = PaystackPop.setup({
        key: PAYSTACK_PUBLIC_KEY,
        email: email,
        amount: amountKobo,
        currency: 'GHS', // Added to ensure GHS is used
        ref: ref,
        // metadata optional
        metadata: {
          custom_fields: [
            { display_name: "Name", variable_name: "fullname", value: fullnameEl.value || '' }
          ]
        },
        callback: function(response){
          // response.reference
          // call Apps Script to verify & allocate vouchers
          verifyOnServer(response.reference, email, qty);
        },
        onClose: function(){
          // user closed window
        }
      });
      handler.openIframe();
    });

    function verifyOnServer(reference, email, qty) {
      resultEl.style.display = 'block';
      resultEl.innerText = 'Verifying payment and fetching voucher...';

      fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'verifyPayment', reference: reference, email: email, qty: qty }),
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        if (data.status === 'success') {
          resultEl.innerText = 'Payment verified. Reference: ' + data.reference + '\n\n' + data.voucherText;
          // trigger browser download
          downloadTextAsFile('vouchers-' + data.reference + '.txt', data.voucherText);
        } else {
          resultEl.innerText = 'Error: ' + (data.message || JSON.stringify(data));
        }
      }).catch(err => {
        resultEl.innerText = 'Error contacting server: ' + err;
      });
    }

    function downloadTextAsFile(filename, text) {
      const blob = new Blob([text], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
    }

    // Re-download by reference
    document.getElementById('fetchBtn').addEventListener('click', function () {
      const ref = document.getElementById('refInput').value.trim();
      if (!ref) { alert('Enter reference'); return; }
      resultEl.style.display = 'block';
      resultEl.innerText = 'Fetching...';
      fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'fetchByRef', reference: ref }),
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(data => {
        if (data.status === 'success') {
          resultEl.innerText = 'Reference: ' + ref + '\n\n' + data.voucherText;
          downloadTextAsFile('vouchers-' + ref + '.txt', data.voucherText);
        } else {
          resultEl.innerText = 'Error: ' + (data.message || JSON.stringify(data));
        }
      }).catch(err => {
        resultEl.innerText = 'Error contacting server: ' + err;
      });
    });

  </script>
</body>
</html>